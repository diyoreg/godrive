# Функция избранных вопросов

## Обзор
Система избранных вопросов позволяет пользователям сохранять понравившиеся вопросы для быстрого доступа и повторного решения.

## Реализованные компоненты

### 1. База данных
**Файл:** `database/migrations/001_add_favorites.sql`
- Добавлена колонка `favorites` (JSONB) в таблицу `users`
- Создан GIN индекс для быстрых JSONB запросов
- Тип данных: массив ID вопросов `[101, 205, 333, ...]`

**Запуск миграции:**
```bash
node database/run-migration.js
```

### 2. Backend API
**Файл:** `routes/favorites.js`

**Эндпоинты:**
- `GET /api/favorites` - получить список избранных вопросов
- `POST /api/favorites` - добавить вопрос в избранное
  - Body: `{ "questionId": 101 }`
- `DELETE /api/favorites` - удалить вопрос из избранного
  - Body: `{ "questionId": 101 }`
- `DELETE /api/favorites/clear` - очистить все избранные

Все эндпоинты требуют авторизации (`authenticateToken` middleware).

### 3. Frontend - ticket.html
**Изменения:**
- Добавлена кнопка со звездой (☆/★) рядом с текстом вопроса
- Размер: 40x40px, дизайн в стиле glass-morphism
- Активное состояние: желтая звезда с пульсацией
- Стили: `.favorite-btn`, `.favorite-btn.active`, `@keyframes favoritePulse`

**JavaScript методы:**
```javascript
async loadFavorites()           // Загрузка избранных из API
updateFavoriteButton(questionId) // Обновление визуального состояния
async toggleFavorite(questionId) // Добавление/удаление из избранного
```

**Использование:**
- При загрузке страницы: `await this.loadFavorites()`
- При показе вопроса: `this.updateFavoriteButton(question.question_id)`
- При клике на звезду: вызывается `toggleFavorite()`

### 4. Страница избранного - favorites.html
**Функционал:**
- Отображение всех избранных вопросов в виде сетки карточек
- Превью вопроса (текст + изображение)
- Кнопка удаления на каждой карточке
- Клик по карточке → переход к билету с этим вопросом
- Кнопка "Очистить всё" для удаления всех избранных
- Счетчик избранных вопросов в заголовке

**Дизайн:**
- Glass-morphism карточки
- Адаптивная сетка (3 колонки → 1 колонка на мобильных)
- Empty state если нет избранных
- Loading state при загрузке

### 5. Dashboard интеграция
**Файлы:** `dashboard.html`, `js/dashboard.js`

**Изменения:**
- Кнопка "⭐ Избранное" в header с счетчиком
- Метод `loadFavoritesCount()` для загрузки количества
- Автоматическое обновление счетчика при загрузке дашборда

## Архитектура

### Поток данных
1. **Добавление в избранное:**
   ```
   Клик на ☆ → toggleFavorite() → POST /api/favorites 
   → UPDATE users SET favorites → Обновление UI (☆→★)
   ```

2. **Загрузка избранных:**
   ```
   init() → loadFavorites() → GET /api/favorites 
   → Set(favoriteQuestions) → updateFavoriteButton()
   ```

3. **Страница избранного:**
   ```
   favorites.html → GET /api/favorites → [101, 205, ...]
   → fetch q0101.json, q0205.json → renderQuestions()
   ```

### Хранение данных
- **База:** PostgreSQL, таблица `users`, колонка `favorites` (JSONB)
- **Формат:** `[101, 205, 333, 444]` (массив question_id)
- **Индекс:** GIN для быстрых операций с JSONB
- **Frontend:** `Set<number>` для быстрой проверки наличия

## Стилистика
- **Цвет активного состояния:** `#fbbf24` (желтый/золотой)
- **Фон активной кнопки:** `rgba(251, 191, 36, 0.2)`
- **Рамка:** `rgba(251, 191, 36, 0.6)`
- **Анимация:** `favoritePulse` - масштабирование при добавлении
- **Иконки:** ☆ (пустая звезда), ★ (залитая звезда)

## Безопасность
- Все API эндпоинты защищены JWT токеном
- Пользователь может управлять только своими избранными
- Проверка авторизации через `authenticateToken` middleware

## Тестирование

### Проверка функционала:
1. Откройте любой билет: `http://localhost:3000/ticket.html?ticket=1`
2. Нажмите на звезду ☆ рядом с вопросом
3. Проверьте, что звезда стала желтой ★
4. Перейдите в Dashboard → кнопка "⭐ Избранное (1)"
5. Откройте `favorites.html` → должен отображаться сохраненный вопрос
6. Нажмите ✕ на карточке → вопрос удалится
7. Вернитесь к билету → звезда снова пустая ☆

### Проверка API:
```bash
# Получить избранные (нужен токен)
curl -H "Authorization: Bearer YOUR_TOKEN" http://localhost:3000/api/favorites

# Добавить в избранное
curl -X POST -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"questionId": 101}' \
  http://localhost:3000/api/favorites

# Удалить из избранного
curl -X DELETE -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"questionId": 101}' \
  http://localhost:3000/api/favorites
```

## Возможные улучшения
1. **Статистика избранных** - сколько раз решён вопрос, % правильных ответов
2. **Фильтры** - решённые/нерешённые, по темам, по билетам
3. **Сортировка** - по дате добавления, по сложности, по теме
4. **Экспорт/импорт** - сохранение избранных в файл
5. **Общий доступ** - возможность поделиться списком избранного
6. **Теги** - пользовательские метки для вопросов
7. **Заметки** - возможность добавлять комментарии к избранным

## Файлы проекта

### Backend
- `routes/favorites.js` - API маршруты
- `database/migrations/001_add_favorites.sql` - миграция БД
- `database/run-migration.js` - скрипт запуска миграции
- `server.js` - регистрация маршрутов `/api/favorites`

### Frontend
- `ticket.html` - кнопка избранного + JS методы
- `favorites.html` - страница со списком избранных
- `dashboard.html` - кнопка перехода к избранному
- `js/dashboard.js` - загрузка счетчика избранных

## История изменений
- **2025-01-xx** - Первая версия системы избранных вопросов
  - Добавлена колонка в БД
  - Реализованы API эндпоинты
  - Создана UI для добавления/удаления
  - Создана страница просмотра избранного
  - Интеграция с dashboard
